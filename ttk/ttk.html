<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="icon" href="icon.png">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
		<script src="https://code.highcharts.com/highcharts.js"></script>
		<script src="https://code.highcharts.com/modules/series-label.js"></script>
		<script src="https://code.highcharts.com/modules/exporting.js"></script>
		<script src="https://code.highcharts.com/modules/export-data.js"></script>
		<script src="https://code.highcharts.com/modules/accessibility.js"></script>
		<script language="javascript" src="scripts/algorithms/damage_distribution.js"></script>
		<script language="javascript" src="scripts/algorithms/gun_vs.js"></script>
		<script language="javascript" src="scripts/algorithms/headshot_to_parts.js"></script>
		<script language="javascript" src="scripts/algorithms/quick_ttk.js"></script>
		<script language="javascript" src="scripts/algorithms/tests.js"></script>
		<script language="javascript" src="scripts/algorithms/ttk_distribution.js"></script>
		<script language="javascript" src="scripts/common/all_guns.js"></script>
		<script language="javascript" src="scripts/common/gun_info.js"></script>
		<script language="javascript" src="scripts/common/lz-string.js"></script>
		<script language="javascript" src="scripts/common/make_series.js"></script>
		<script language="javascript" src="scripts/common/save_data_processing.js"></script>
		<script language="javascript" src="scripts/pages/ttk_add_gun.js"></script>

		<title>Real TTK</title>

		<style type="text/css">
			.highcharts-figure, .highcharts-data-table table {
				min-width: 360px;
				max-width: 800px;
				margin: 1em auto;
			}

			.highcharts-data-table table {
				font-family: Verdana, sans-serif;
				border-collapse: collapse;
				border: 1px solid #EBEBEB;
				margin: 10px auto;
				text-align: center;
				width: 100%;
				max-width: 500px;
			}
			.highcharts-data-table caption {
				padding: 1em 0;
				font-size: 1.2em;
				color: #555;
			}
			.highcharts-data-table th {
				font-weight: 600;
				padding: 0.5em;
			}
			.highcharts-data-table td, .highcharts-data-table th, .highcharts-data-table caption {
				padding: 0.5em;
			}
			.highcharts-data-table thead tr, .highcharts-data-table tr:nth-child(even) {
				background: #f8f8f8;
			}
			.highcharts-data-table tr:hover {
				background: #f1f7ff;
			}
			label {
				margin: 0
			}
		</style>
	</head>
	<body>
		<div class="container-fluid px-5 pt-3">
			<div class="row">
				<div class="col-4">
					<div id="options">
						<a href="how_it_works.html">How it works</a>
						<h4>Options</h4>
						<strong style="line-height:40px">Common</strong>
						<div>
							Total HP:
							<input type="number" class="update_chart" id="total_hp" size="3">
						</div>
						<strong style="line-height:40px">TTK by distance chart</strong>
						<div>
							Default headshot accuracy:
							<input type="number" class="update_chart" id="default_headshot_percent" min="0" max="100" size="3">%
						</div>
						<div>
							Default hit accuracy:
							<input type="number" class="update_chart" id="default_hit_percent" min="0" max="100" size="3">%
						</div>
						<strong style="line-height:40px">Average TTK for range by headshot percent chart</strong>
						<div>
							<div>
								Headshot between
								<input type="number" class="update_chart" id="min_headshot_percent" min="0" max="100">% and 
								<input type="number" class="update_chart" id="max_headshot_percent" min="0" max="100">%
							</div>
							<div>
								Distance between
								<input type="number" class="update_chart" id="min_distance" min="0" max="1000">m and 
								<input type="number" class="update_chart" id="max_distance" min="0" max="1000">m
							</div>
						</div>
					</div>
					<div>
						<h4>Guns</h4>
						<div>This page is shareable and your status is saved in URL. Save it to you bookmark and return at any time!</div>
					</div>
					<div class="input-group mt-3">
						<select class="form-select" id="select_gun"></select>
						&nbsp;&nbsp;<button class="btn btn-outline-secondary btn-sm" id="add_gun">Add Gun</button>
						&nbsp;&nbsp;&nbsp;<a id="custom_gun_link" href="custom_gun.html">Add a custom gun</a>
					</div>
					<br>
					<div id="guns"></div>
				</div>
				
				<div class="col-8">
					<h4 style="color:red"><div id="warning"></div></h4>
					<div id="ttk_for_various_distance"></div>
					<div id="ttk_for_various_headshot_percent"></div>
				</div>
			</div>
		</div>


		<script type="text/javascript">
			Highcharts.setOptions({
				lang: {
					thousandsSep: ""
				}
			});
			// options operations
			function get_options(){
				var options = {};
				for (var key in DEFAULT_OPTIONS){
					options[key] = Number($('#'+key).val());
				}
				return options;
			}

			function set_options(options){
				for (var key in options){
					$('#'+key).val(options[key]);
				}
			}
			
			$('#options').find('input').change(function(){
				update_page();
			});

			// gun selection and list operations
			function create_gun_selection(){
				var select_gun = $('#select_gun');
				for (var i = 0; i < DEFAULT_GUNS.length; i++) {
					var el = document.createElement('option');
					el.text = DEFAULT_GUNS[i].name;
					el.value = JSON.stringify(DEFAULT_GUNS[i]);
					select_gun.append(el);
				}
			}
			
			function add_gun_obj(gun_obj){
				var gun_div=create_gun_div(gun_obj);
				gun_div.find('.remove_gun').click(function(){
					$(this).closest('.gun').remove();
				});
				$('#guns').append(gun_div);
			}

			$('#add_gun').click(function(){
				var selected=$('#select_gun option:selected');
				if(selected.length == 0){
					return;
				}
				var gun_json=selected.eq(0).val();
				var gun = JSON.parse(gun_json);
				add_gun_obj(gun);
				update_page();
			});
			
			function get_current_guns(){
				var guns=[];
				$('.gun').each(function(){
					guns.push(get_gun_obj($(this)));
				});
				return guns;
			}

			// page operations
			function compose_save_data(){
				return {
					version: '0.1',
					guns: get_current_guns().map(persistent_gun),
					options: get_options()
				};
			}
			
			function ttk_chart_highcharts_obj(title_text, x_axis_text, series_array){				
				return {
					plotOptions: {
						series: {
							animation: false,
							marker: {
								enabled: false,
							},
						}
					},
					title: {
						text: title_text
					},
					tooltip: {
						shared: true,
					},
					yAxis: {
						title: {
							text: 'ms'
						}
					},
					xAxis: {
						title: {
							text: x_axis_text
						},
						crosshair: true
					},
					legend: {
						layout: 'horizontal',
						align: 'center',
						verticalAlign: 'top',
					},
					series: series_array,
				};
			}

			function get_array(min_val, max_val, step){
				var array=[];
				for (var val = Math.floor(min_val/step); val <= Math.ceil(max_val/step); val+=step){
					array.push(val);
				}
				return array;
			}

			function get_save_data_str(){
				var save_data = compose_save_data();
				return LZString.compressToEncodedURIComponent(JSON.stringify(save_data));
			}

			function update_page(alert_msg=''){
				var save_data_str = get_save_data_str();
				var newurl = window.location.origin + window.location.pathname + '?save_data=' + save_data_str;
				window.history.replaceState({ path: newurl }, '', newurl);


				var custom_gun_url = 'custom_gun.html?save_data=' + save_data_str;
				$('#custom_gun_link').attr('href', custom_gun_url);


				if (alert_msg) {
					alert('refreshed '+msg);
				}
				setTimeout(update_chart, 0);
			}
			
			function update_chart(){
				var guns = get_current_guns();
				var options = get_options();
				var series_array = make_series_for_various_distance(options.total_hp, guns, get_array(0, 100, 1), options.default_headshot_percent, options.default_hit_percent);
				var chart_options = [options.default_headshot_percent + '% headshot'];
				
				if (options.default_hit_percent != 100) {
					chart_options.push(options.default_hit_percent + '% hit');
				}
				
				var chart_options_in_title = chart_options.join('; ');
				var chart_obj = ttk_chart_highcharts_obj('TTK (' + chart_options_in_title+ ') by distance', 'distance (m)', series_array)
				Highcharts.chart('ttk_for_various_distance', chart_obj);
				var d_array = get_array(options.min_distance, options.max_distance, 1);
				var hs_p_array = get_array(options.min_headshot_percent, options.max_headshot_percent, 1);
				series_array = make_series_for_various_headshot_percent(options.total_hp, guns, d_array, hs_p_array, options.default_hit_percent);
				chart_obj = ttk_chart_highcharts_obj(''+d_array[0]+'-'+d_array[d_array.length-1]+'m average TTK by headshot ('+hs_p_array[0]+'% - '+hs_p_array[hs_p_array.length-1]+'%)', 'headshot percent', series_array)
				Highcharts.chart('ttk_for_various_headshot_percent', chart_obj);
			}

			function init(){
				// initialize page elements
				create_gun_selection();
				$('#select_gun').change();
				
				// load and apply save data
				load_saved_data();
				set_options(SAVE_DATA.options);
				for(var i=0;i<SAVE_DATA.guns.length;i++){
					add_gun_obj(recover_gun(SAVE_DATA.guns[i]));
				}
				
				update_page();
			}
			init();
			
			// util functions
			function copy_text(selector){
			  var $input = $(selector);
			  var el = $input.get(0);
			  var editable = el.contentEditable;
			  var readOnly = el.readOnly;
			  el.contentEditable = true;
			  el.readOnly = false;
			  var range = document.createRange();
			  range.selectNodeContents(el);
			  var sel = window.getSelection();
			  sel.removeAllRanges();
			  sel.addRange(range);
			  el.setSelectionRange(0, 999999);
			  el.contentEditable = editable;
			  el.readOnly = readOnly;
			  document.execCommand('copy');
			  $input.select();
			  document.execCommand('copy');
			  $input.blur();
			}
		</script>
	</body>
</html>
